<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard â€” Retrieval Track</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
</head>
<body>
<button class="hamburger" id="hamburger-btn">â˜°</button>
<div class="app-layout">
  <aside class="sidebar" id="sidebar"></aside>
  <div class="main">
    <div class="topbar">
      <div class="topbar-title">ğŸ  Dashboard</div>
      <div class="topbar-actions">
        <span id="dash-date" style="font-size:12px;color:var(--text-muted);"></span>
        <a href="admin-import.html" class="btn btn-outline btn-sm">+ Add Device</a>
        <a href="issue-device.html" class="btn btn-accent btn-sm">ğŸ“¤ Issue Device</a>
      </div>
    </div>
    <div class="page-inner">
      <div class="page-header">
        <div>
          <div class="page-title">Live Operations Dashboard</div>
          <div class="page-desc" id="dash-sub">Real-time port device management overview</div>
        </div>
        <div class="header-actions">
          <button class="btn btn-outline btn-sm" onclick="window.print()">ğŸ–¨ï¸ Print Report</button>
        </div>
      </div>

      <!-- STATS -->
      <div class="stats-grid" id="dash-stats"></div>

      <!-- CHARTS ROW -->
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:18px;">
        <div class="chart-card">
          <div class="chart-title">Devices by Status</div>
          <div class="donut-wrap">
            <svg id="dash-donut" width="130" height="130" viewBox="0 0 130 130"></svg>
            <div class="legend-list" id="dash-legend"></div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Devices by Regime</div>
          <div class="bar-chart" id="dash-regime-bars"></div>
        </div>
        <div class="chart-card" style="grid-column:1/-1;">
          <div class="chart-title">Retrieved vs Delayed â€” Last 6 Months</div>
          <canvas id="dash-month-chart" width="600" height="150" style="width:100%;height:auto;"></canvas>
        </div>
      </div>

      <!-- ALERTS ROW -->
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:18px;">
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ”´ Top Delayed Devices</div>
            <a href="delayed.html" class="btn btn-ghost btn-sm">View all â†’</a>
          </div>
          <div id="dash-delayed-list"></div>
        </div>
        <div class="card">
          <div class="card-header">
            <div class="card-title">ğŸ“… Upcoming Retrievals</div>
            <a href="retrieval.html" class="btn btn-ghost btn-sm">View all â†’</a>
          </div>
          <div id="dash-upcoming-list"></div>
        </div>
      </div>

      <!-- RECENT ACTIVITY -->
      <div class="card">
        <div class="card-header">
          <div class="card-title">âš¡ Recent Activity</div>
          <button class="btn btn-ghost btn-sm" onclick="renderActivity()">ğŸ”„ Refresh</button>
        </div>
        <div id="dash-activity"></div>
      </div>
    </div>
  </div>
</div>
<div id="toast"></div>
<script src="db.js"></script>
<script src="shared.js"></script>
<script>
const session = pageInit('dashboard');
if (session) {
  document.getElementById('dash-date').textContent = fmtDate(TODAY);
  document.getElementById('dash-sub').textContent = `Welcome back, ${session.name} â€” ${fmtDate(TODAY)}`;
  renderDashboard();
}

function renderDashboard() {
  const devices = DB.getDevices();
  const total     = devices.length;
  const retrieved = devices.filter(d => d.status === 'Retrieved').length;
  const delayed   = devices.filter(d => d.isDelayed && d.status !== 'Retrieved').length;
  const awaiting  = devices.filter(d => d.status === 'Awaiting Retrieval' && !d.isDelayed).length;
  const unconfirmed = devices.filter(d => !d.fieldConfirmed && d.status !== 'Retrieved').length;
  const rate = total > 0 ? Math.round(retrieved/total*100) : 0;
  const issuances = DB.getIssuances();

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat-card c-navy"><div class="stat-icon">ğŸ“¦</div><div class="stat-value">${total}</div><div class="stat-label">Total Devices</div><div class="stat-sub">${devices.filter(d=>d.status!=='Retrieved').length} active</div></div>
    <div class="stat-card c-accent"><div class="stat-icon">âœ…</div><div class="stat-value">${retrieved}</div><div class="stat-label">Retrieved</div><div class="stat-sub up">â†‘ ${rate}% retrieval rate</div></div>
    <div class="stat-card c-red"><div class="stat-icon">âš ï¸</div><div class="stat-value">${delayed}</div><div class="stat-label">Delayed</div><div class="stat-sub down">Require immediate action</div></div>
    <div class="stat-card c-yellow"><div class="stat-icon">â³</div><div class="stat-value">${awaiting}</div><div class="stat-label">Awaiting Retrieval</div><div class="stat-sub">Field confirmed</div></div>
    <div class="stat-card c-orange"><div class="stat-icon">ğŸ”</div><div class="stat-value">${unconfirmed}</div><div class="stat-label">Unconfirmed</div><div class="stat-sub">Pending field check</div></div>
    <div class="stat-card c-purple"><div class="stat-icon">ğŸ“</div><div class="stat-value">${issuances.length}</div><div class="stat-label">Total Issuances</div></div>`;

  // Donut
  drawDonut('dash-donut','dash-legend', [
    {label:'Awaiting',val:awaiting,color:'#f0833a'},
    {label:'Retrieved',val:retrieved,color:'#00c5a3'},
    {label:'Delayed',val:delayed,color:'#e84040'},
    {label:'Unconfirmed',val:unconfirmed,color:'#f5c842'},
  ], total);

  // Regime bars
  const rc = {};
  REGIMES.forEach(r => rc[r] = 0);
  devices.forEach(d => rc[d.regime] = (rc[d.regime]||0)+1);
  drawBars('dash-regime-bars', REGIMES.map(r => ({label:r,val:rc[r]})), item => REGIME_COLORS[item.label]);

  // Month chart
  drawMonthChart('dash-month-chart', devices);

  // Delayed list
  const topDelayed = devices.filter(d => d.isDelayed && d.status !== 'Retrieved').sort((a,b) => b.daysOverdue-a.daysOverdue).slice(0,5);
  document.getElementById('dash-delayed-list').innerHTML = topDelayed.length
    ? topDelayed.map(d => `
      <div style="display:flex;align-items:center;gap:10px;padding:10px 18px;border-bottom:1px solid var(--border);">
        <div class="overdue-badge">${d.daysOverdue}</div>
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:12px;font-family:'Syne',sans-serif;">${d.id}</div>
          <div style="font-size:11px;color:var(--text-muted);">${d.agency} Â· ${regBadge(d.regime)}</div>
        </div>
        <a href="delayed.html" class="btn btn-xs btn-danger">Act</a>
      </div>`).join('')
    : `<div class="empty-state"><div class="empty-icon">âœ…</div><div class="empty-title">No delayed devices</div></div>`;

  // Upcoming
  const upcoming = devices.filter(d => {
    if (d.status === 'Retrieved' || d.isDelayed) return false;
    const days = Math.ceil((new Date(d.expectedReturn) - TODAY) / 86400000);
    return days >= 0 && days <= 5;
  }).sort((a,b) => new Date(a.expectedReturn)-new Date(b.expectedReturn)).slice(0,5);
  document.getElementById('dash-upcoming-list').innerHTML = upcoming.length
    ? upcoming.map(d => {
        const days = Math.ceil((new Date(d.expectedReturn) - TODAY) / 86400000);
        return `<div style="display:flex;align-items:center;gap:10px;padding:10px 18px;border-bottom:1px solid var(--border);">
          <div style="width:36px;height:36px;border-radius:9px;background:rgba(245,200,66,.15);display:flex;align-items:center;justify-content:center;font-size:16px;">ğŸ“…</div>
          <div style="flex:1;min-width:0;">
            <div style="font-weight:700;font-size:12px;font-family:'Syne',sans-serif;">${d.id}</div>
            <div style="font-size:11px;color:var(--text-muted);">${d.agency} Â· due in <strong style="color:${days===0?'var(--red)':'#d97706'}">${days===0?'today':days+' day'++(days!==1?'s':'')}</strong></div>
          </div>
        </div>`;}).join('')
    : `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No upcoming deadlines</div></div>`;

  renderActivity();
}

function renderActivity() {
  const devices = DB.getDevices();
  const issuances = DB.getIssuances();
  const notifs = DB.getNotifications();
  const acts = [
    ...devices.filter(d=>d.status==='Retrieved').slice(0,3).map(d=>({icon:'âœ…',text:`Device ${d.id} retrieved from ${d.agency}`,time:'Today',color:'var(--accent)'})),
    ...devices.filter(d=>d.isDelayed).slice(0,3).map(d=>({icon:'âš ï¸',text:`${d.id} is ${d.daysOverdue} days overdue â€“ ${d.agency}`,time:'Auto-flagged',color:'var(--red)'})),
    ...issuances.slice(0,3).map(i=>({icon:'ğŸ“¤',text:`${i.officerName} issued ${i.collected} device(s) from ${i.agency}`,time:fmtDateShort(i.createdAt),color:'var(--navy)'})),
    ...notifs.slice(0,3).map(n=>({icon:'ğŸ””',text:n.title,time:timeAgo(n.createdAt),color:'#7c3aed'})),
  ].slice(0,10);
  document.getElementById('dash-activity').innerHTML = acts.length
    ? acts.map(a=>`<div style="display:flex;align-items:flex-start;gap:11px;padding:11px 18px;border-bottom:1px solid var(--border);">
        <div style="width:8px;height:8px;border-radius:50%;background:${a.color};flex-shrink:0;margin-top:5px;"></div>
        <div style="flex:1;font-size:13px;">${a.icon} ${a.text}</div>
        <div style="font-size:11px;color:var(--text-muted);white-space:nowrap;">${a.time}</div>
      </div>`).join('')
    : `<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No recent activity</div></div>`;
}
</script>
</body>
</html>
