<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Officer Performance ‚Äî Retrieval Track</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
</head>
<body>
<button class="hamburger" id="hamburger-btn">‚ò∞</button>
<div class="app-layout">
  <aside class="sidebar" id="sidebar"></aside>
  <div class="main">
    <div class="topbar"><div class="topbar-title">üèÜ Officer Performance</div></div>
    <div class="page-inner">
      <div class="page-header">
        <div>
          <div class="page-title">Officer Performance Scorecard</div>
          <div class="page-desc">Track retrieval rates, on-time performance, and incomplete pickup frequency per officer.</div>
        </div>
        <div class="header-actions">
          <button class="btn btn-outline btn-sm" onclick="window.print()">üñ®Ô∏è Print</button>
        </div>
      </div>
      <div id="perf-content"></div>
    </div>
  </div>
</div>
<div id="toast"></div>
<script src="db.js"></script>
<script src="shared.js"></script>
<script>
const session = pageInit('performance');
if (session) renderPerf();

function renderPerf() {
  const officers = Object.keys(OFFICERS_DATA);
  document.getElementById('perf-content').innerHTML = officers.map(o => perfCard(o)).join('');
}

function perfCard(o) {
  const oInfo     = OFFICERS_DATA[o];
  const issuances = DB.getIssuances().filter(i => i.officerName === o);
  const myRet     = DB.getDevices().filter(d => d.retrievalOfficer === o);
  const totQ      = issuances.reduce((a,b)=>a+b.qty,0);
  const totC      = issuances.reduce((a,b)=>a+b.collected,0);
  const totP      = issuances.reduce((a,b)=>a+b.pending,0);
  const incomplete = issuances.filter(i=>i.pending>0).length;
  const onTime     = myRet.filter(d=>!d.isDelayed).length;
  const rate       = totQ > 0 ? Math.round(totC/totQ*100) : 0;
  const score      = Math.min(100, Math.max(0, rate - incomplete*5 + myRet.length*3));
  const scoreColor = score>=80 ? '#00c5a3' : score>=50 ? '#f5c842' : '#e84040';
  const grade      = score>=90?'A+':score>=80?'A':score>=70?'B':score>=60?'C':'D';
  const init       = o.split(' ').map(w=>w[0]).join('').slice(0,2);

  // Recent issuances breakdown
  const recentR = issuances.slice(-5).reverse();

  return `
  <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:22px;margin-bottom:16px;box-shadow:var(--shadow);">
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;flex-wrap:wrap;">
      <div style="width:52px;height:52px;border-radius:50%;background:${oInfo.color};display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:18px;flex-shrink:0;">${init}</div>
      <div style="flex:1;">
        <div style="font-family:'Syne',sans-serif;font-weight:700;font-size:16px;">${o}</div>
        <div style="font-size:12px;color:var(--text-muted);">+${oInfo.phone} &nbsp;¬∑&nbsp; Retrieval Officer</div>
      </div>
      <!-- Score Circle -->
      <svg width="60" height="60" viewBox="0 0 60 60" style="flex-shrink:0;">
        <circle cx="30" cy="30" r="24" fill="none" stroke="var(--border)" stroke-width="5"/>
        <circle cx="30" cy="30" r="24" fill="none" stroke="${scoreColor}" stroke-width="5"
          stroke-dasharray="${(score/100*150.8).toFixed(1)} 150.8"
          stroke-linecap="round" transform="rotate(-90,30,30)"/>
        <text x="30" y="26" text-anchor="middle" font-family="Syne,sans-serif" font-weight="800" font-size="12" fill="var(--text)">${score}</text>
        <text x="30" y="38" text-anchor="middle" font-size="9" fill="var(--text-muted)">${grade}</text>
      </svg>
      <a href="officer-tracker.html" class="btn btn-outline btn-sm">View Tracker ‚Üí</a>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px;margin-bottom:18px;">
      <div class="perf-stat"><div class="perf-stat-val" style="color:var(--navy)">${issuances.length}</div><div class="perf-stat-lbl">Issuances</div></div>
      <div class="perf-stat"><div class="perf-stat-val" style="color:var(--accent)">${totC}</div><div class="perf-stat-lbl">Collected</div></div>
      <div class="perf-stat"><div class="perf-stat-val" style="color:var(--red)">${totP}</div><div class="perf-stat-lbl">Pending</div></div>
      <div class="perf-stat"><div class="perf-stat-val" style="color:var(--accent2)">${incomplete}</div><div class="perf-stat-lbl">Incomplete</div></div>
      <div class="perf-stat"><div class="perf-stat-val" style="color:#007a67">${myRet.length}</div><div class="perf-stat-lbl">Retrieved</div></div>
      <div class="perf-stat"><div class="perf-stat-val" style="color:#007a67">${onTime}</div><div class="perf-stat-lbl">On-Time</div></div>
    </div>

    <div style="margin-bottom:14px;">
      <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--text-muted);margin-bottom:4px;">
        <span>Collection Rate</span><span style="font-weight:700;color:${scoreColor};">${rate}%</span>
      </div>
      <div class="perf-bar-track"><div class="perf-bar-fill" style="width:${rate}%;background:${scoreColor};"></div></div>
    </div>

    ${recentR.length ? `
    <div style="border-top:1px solid var(--border);padding-top:14px;">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.05em;margin-bottom:10px;">Recent Issuances</div>
      ${recentR.map(i=>`
        <div style="display:flex;align-items:center;gap:10px;font-size:12px;padding:5px 0;border-bottom:1px solid var(--border);">
          <div style="flex:1;">${i.agency}</div>
          <div>‚úÖ ${i.collected} / ${i.qty}</div>
          ${i.pending>0?`<div style="color:var(--red);">‚è≥ ${i.pending} pending</div>`:'<div style="color:var(--accent);">Complete</div>'}
          <div style="color:var(--text-muted);">${timeAgo(i.createdAt)}</div>
        </div>`).join('')}
    </div>` : ''}
  </div>`;
}
</script>
</body>
</html>
