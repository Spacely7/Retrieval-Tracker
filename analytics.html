<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analytics â€” Retrieval Track</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared.css">
</head>
<body>
<button class="hamburger" id="hamburger-btn">â˜°</button>
<div class="app-layout">
  <aside class="sidebar" id="sidebar"></aside>
  <div class="main">
    <div class="topbar"><div class="topbar-title">ğŸ“Š Analytics</div></div>
    <div class="page-inner">
      <div class="page-header">
        <div>
          <div class="page-title">Device Analytics</div>
          <div class="page-desc">Visualise key metrics across all device operations.</div>
        </div>
      </div>
      <div class="filter-bar">
        <div class="search-wrap"><span class="search-icon">ğŸ”</span><input type="text" id="ana-search" placeholder="Search Device ID, Agency..." oninput="load()"></div>
        <select class="filter-select" id="ana-regime" onchange="load()">
          <option value="">All Regimes</option>
          <option>Warehouse</option><option>Freezones</option><option>Re-Export</option><option>Transit</option><option>Petroleum</option>
        </select>
      </div>
      <div class="stats-grid" id="ana-stats"></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;">
        <div class="chart-card">
          <div class="chart-title">Devices by Status</div>
          <div class="donut-wrap">
            <svg id="ana-donut" width="130" height="130" viewBox="0 0 130 130"></svg>
            <div class="legend-list" id="ana-legend"></div>
          </div>
        </div>
        <div class="chart-card">
          <div class="chart-title">By Regime</div>
          <div class="bar-chart" id="ana-regime-bars"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Top Agencies by Device Count</div>
          <div class="bar-chart" id="ana-agency-bars"></div>
        </div>
        <div class="chart-card">
          <div class="chart-title">Retrieved vs Delayed â€” 6 Months</div>
          <canvas id="ana-month" width="320" height="170" style="width:100%;height:auto;"></canvas>
        </div>
        <div class="chart-card" style="grid-column:1/-1;">
          <div class="chart-title">SLA Compliance by Regime</div>
          <div id="sla-compliance-bars" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="toast"></div>
<script src="db.js"></script>
<script src="shared.js"></script>
<script>
const session = pageInit('analytics');
if (session) load();

function load() {
  const search = (document.getElementById('ana-search')?.value||'').toLowerCase();
  const regime = document.getElementById('ana-regime')?.value||'';
  const data = DB.getDevices().filter(d => {
    if (regime && d.regime !== regime) return false;
    if (search && !d.id.toLowerCase().includes(search) && !d.agency.toLowerCase().includes(search)) return false;
    return true;
  });

  const total     = data.length;
  const retrieved = data.filter(d=>d.status==='Retrieved').length;
  const delayed   = data.filter(d=>d.isDelayed&&d.status!=='Retrieved').length;
  const awaiting  = data.filter(d=>d.status==='Awaiting Retrieval'&&!d.isDelayed).length;
  const unconfirmed = data.filter(d=>!d.fieldConfirmed&&d.status!=='Retrieved').length;
  const avgDays = data.filter(d=>d.status==='Retrieved').reduce((sum,d) => {
    return sum + Math.max(0, daysBetween(d.retrievalTime||TODAY, d.issued));
  },0) / (retrieved||1);

  document.getElementById('ana-stats').innerHTML = `
    <div class="stat-card c-navy"><div class="stat-icon">ğŸ“¦</div><div class="stat-value">${total}</div><div class="stat-label">Total Devices</div></div>
    <div class="stat-card c-accent"><div class="stat-icon">âœ…</div><div class="stat-value">${retrieved}</div><div class="stat-label">Retrieved</div><div class="stat-sub up">â†‘ ${total?Math.round(retrieved/total*100):0}% rate</div></div>
    <div class="stat-card c-red"><div class="stat-icon">âš ï¸</div><div class="stat-value">${delayed}</div><div class="stat-label">Delayed</div></div>
    <div class="stat-card c-yellow"><div class="stat-icon">â³</div><div class="stat-value">${awaiting}</div><div class="stat-label">Awaiting</div></div>
    <div class="stat-card c-orange"><div class="stat-icon">ğŸ”</div><div class="stat-value">${unconfirmed}</div><div class="stat-label">Unconfirmed</div></div>
    <div class="stat-card c-purple"><div class="stat-icon">ğŸ“ˆ</div><div class="stat-value">${avgDays.toFixed(1)}d</div><div class="stat-label">Avg Retrieval Time</div></div>`;

  drawDonut('ana-donut','ana-legend',[
    {label:'Awaiting',val:awaiting,color:'#f0833a'},
    {label:'Retrieved',val:retrieved,color:'#00c5a3'},
    {label:'Delayed',val:delayed,color:'#e84040'},
    {label:'Unconfirmed',val:unconfirmed,color:'#f5c842'},
  ],total);

  const rc={};REGIMES.forEach(r=>rc[r]=0);data.forEach(d=>rc[d.regime]=(rc[d.regime]||0)+1);
  drawBars('ana-regime-bars', REGIMES.map(r=>({label:r,val:rc[r]})), item=>REGIME_COLORS[item.label]);

  const ac={};data.forEach(d=>ac[d.agency]=(ac[d.agency]||0)+1);
  const topA = Object.entries(ac).sort((a,b)=>b[1]-a[1]).slice(0,8).map(([label,val])=>({label,val}));
  drawBars('ana-agency-bars', topA, ()=>REGIME_COLORS['Warehouse']);

  drawMonthChart('ana-month', data);

  // SLA Compliance per regime
  const sla = DB.getSLA();
  document.getElementById('sla-compliance-bars').innerHTML = REGIMES.map(r => {
    const rDevices = data.filter(d=>d.regime===r&&d.status!=='Retrieved');
    const inSla    = rDevices.filter(d=>!d.isDelayed).length;
    const pct      = rDevices.length ? Math.round(inSla/rDevices.length*100) : 100;
    const color    = pct>=90?'#00c5a3':pct>=70?'#f5c842':'#e84040';
    return `<div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;">
      <div style="font-size:11px;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:.04em;margin-bottom:8px;">${r}</div>
      <div style="font-family:'Syne',sans-serif;font-weight:800;font-size:24px;color:${color};">${pct}%</div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">${inSla}/${rDevices.length} in SLA Â· ${sla[r]||3}d threshold</div>
      <div class="perf-bar-track" style="margin-top:8px;"><div class="perf-bar-fill" style="width:${pct}%;background:${color};"></div></div>
    </div>`;
  }).join('');
}
</script>
</body>
</html>
